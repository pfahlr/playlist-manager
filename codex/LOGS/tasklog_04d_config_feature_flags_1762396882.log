OpenAI Codex v0.55.0 (research preview)
--------
workdir: /var/home/rick/Development/playlist-manager
model: gpt-5-codex
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: high
reasoning summaries: auto
session id: 019a570a-47d8-7ec1-b9c2-e71eaf87612c
--------
user
Implement the functionality described in codex/TASKS/04d_config_feature_flags.yaml, then verify with any available tests.

thinking
**Reviewing feature flag task instructions**
exec
bash -lc 'ls codex/TASKS' in /var/home/rick/Development/playlist-manager/. succeeded in 91ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
00_repo_sanity_review.yaml
01a_spec_bootstrap.yaml
02a_prisma_init.yaml
02b_raw_migrations.yaml
02c_prisma_seeds.yaml
02d_db_indexes_bench.yaml
03a_dbpkg_singleton.yaml
03b_db_migration_ci_gate.yaml
03c_token_encryption_at_rest.yaml
04a_api_validation_wiring.yaml
04b_openapi_warning_silencer.yaml
04c_api_docs_ui.yaml
04d_config_feature_flags.yaml
05a_pif_validator.yaml
05b_file_exporters.yaml
05c_importers_file.yaml
06a_provider_interfaces.yaml
06b_spotify_impl.yaml

thinking
**Fetching content of 04d**
exec
bash -lc 'cat codex/TASKS/04d_config_feature_flags.yaml' in /var/home/rick/Development/playlist-manager/. succeeded in 39ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
id: 04d_config_feature_flags
title: Feature flags for providers & endpoints
branch: codex/04d_config_feature_flags
overview: >
  Introduce a simple feature-flag layer (env or JSON config) to enable/disable providers and risky routes.
  Expose flags via /auth/providers. Add deny middleware for disabled features.
acceptance:
  - toggling PROVIDERS_SPOTIFY_ENABLED=false hides it in /auth/providers and blocks related routes with 503
  - tests assert blocked behavior returns the standard error envelope
artifacts_to_touch:
  - apps/api/src/config/flags.ts (.env.example: PROVIDERS_* booleans)
  - apps/api/src/plugins/feature-guard.ts
  - apps/api/src/routes/auth.providers.ts
steps:
  - Parse flags from env; inject guard middleware where needed

thinking
**Formulating multi-step plan**
Plan update
Need to add feature flags; plan to inspect existing implementation, write tests, implement, then verify.
  → Review existing config, routes, and spec to understand current provider listing and guards
  • Add failing tests covering feature flag behavior for disabled providers and blocked routes
  • Implement env-driven feature flags and middleware updates to satisfy tests
  • Run relevant test suite to confirm green

thinking
**Listing files in apps/api**
exec
bash -lc 'ls apps/api/src' in /var/home/rick/Development/playlist-manager/. succeeded in 42ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
config
dev
lib
middleware.ts
plugins
routes
testServer.ts

thinking
**Checking relevant config paths**
exec
bash -lc 'ls apps/api/src/config' in /var/home/rick/Development/playlist-manager/. succeeded in 41ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
env.ts
flags.ts

thinking
**Viewing flags file**
exec
bash -lc 'cat apps/api/src/config/flags.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 40ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
export type ProviderFlagName = 'spotify' | 'deezer' | 'tidal' | 'youtube';

const bool = (v: string | undefined, d = false) =>
  v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;

export const flags = {
  providers: {
    spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
    deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
    tidal:   bool(process.env.PROVIDERS_TIDAL_ENABLED, false),
    youtube: bool(process.env.PROVIDERS_YOUTUBE_ENABLED, false)
  }
};

export function isProviderEnabled(name: ProviderFlagName): boolean {
  return !!flags.providers[name];
}

thinking
**Examining feature-guard.ts**
exec
bash -lc 'cat apps/api/src/plugins/feature-guard.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 40ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import fp from 'fastify-plugin';
import { isProviderEnabled, ProviderFlagName } from '../config/flags';

export default fp(async (app) => {
  app.decorate('requireProvider', (name: ProviderFlagName) => {
    if (!isProviderEnabled(name)) {
      const err: any = new Error(`${name} is disabled`);
      err.statusCode = 503;
      err.code = 'provider_disabled';
      throw err;
    }
  });
});

declare module 'fastify' {
  interface FastifyInstance {
    requireProvider(name: ProviderFlagName): void;
  }

thinking
**Checking unused flames and route setup**
exec
bash -lc 'cat apps/api/src/routes/auth.providers.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 48ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import { FastifyInstance } from 'fastify';
import { flags } from '../config/flags';

export default async function authProviders(app: FastifyInstance) {
  app.get('/auth/providers', async () => {
    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
    return { data };
  });
}

thinking
**Clarifying provider filtering and blocking**
exec
bash -lc 'rg "auth/providers" -n' in /var/home/rick/Development/playlist-manager/. succeeded in 2.60s:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:51:  Expose flags via /auth/providers. Add deny middleware for disabled features.
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:53:  - toggling PROVIDERS_SPOTIFY_ENABLED=false hides it in /auth/providers and blocks related routes with 503
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:153:  app.get('/auth/providers', async () => {
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:162:bash -lc 'rg "auth/providers" -n' in /var/home/rick/Development/playlist-manager/.
codex/TASKS/04d_config_feature_flags.yaml:6:  Expose flags via /auth/providers. Add deny middleware for disabled features.
codex/TASKS/04d_config_feature_flags.yaml:8:  - toggling PROVIDERS_SPOTIFY_ENABLED=false hides it in /auth/providers and blocks related routes with 503
codex/TASKS/10e_openapi_auth_completion.yaml:5:  Extend openapi.yaml with /auth/providers, /auth/mobile/authorize, /auth/mobile/attempts/{id},
codex/TASKS/10d_backend_oauth_callbacks.yaml:14:  - apps/api/src/lib/auth/providers/spotify.ts
codex/TASKS/10b_mobile_oauth_pkce.yaml:5:  Implement server endpoints /auth/providers, /auth/mobile/authorize, /auth/mobile/attempts/{id}.
codex/TASKS/10b_mobile_oauth_pkce.yaml:20:  - Implement /auth/providers, /auth/mobile/authorize, /auth/mobile/attempts/{id}.
apps/api/src/routes/auth.providers.ts:5:  app.get('/auth/providers', async () => {
codex/LOGS/tasklog_03c_token_encryption_at_rest_1762393669.log:513:apps/api/src/routes/auth.providers.ts:5:  app.get('/auth/providers', async () => {

thinking
**Checking for existing tests**
exec
bash -lc 'rg "requireProvider" -n' in /var/home/rick/Development/playlist-manager/. succeeded in 44ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:128:  app.decorate('requireProvider', (name: ProviderFlagName) => {
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:140:    requireProvider(name: ProviderFlagName): void;
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:181:bash -lc 'rg "requireProvider" -n' in /var/home/rick/Development/playlist-manager/.
apps/api/src/plugins/feature-guard.ts:5:  app.decorate('requireProvider', (name: ProviderFlagName) => {
apps/api/src/plugins/feature-guard.ts:17:    requireProvider(name: ProviderFlagName): void;

thinking
**Searching routes for Spotify guard**
exec
bash -lc 'rg "requireProvider" -n apps/api/src/routes' in /var/home/rick/Development/playlist-manager/. exited 1 in 43ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory

thinking
**Checking playlist-related routes**
exec
bash -lc 'ls apps/api/src/routes' in /var/home/rick/Development/playlist-manager/. succeeded in 46ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
active-playlist
artists
auth.providers.ts
docs.ts
exports
imports.file.ts
jobs
jobs.events.ts
_mockData.ts
playlists
register-handlers.ts
__tests__

thinking
**Exploring auth and route files**
exec
bash -lc 'ls apps/api/src/routes/__tests__' in /var/home/rick/Development/playlist-manager/. succeeded in 43ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
docs.test.ts
register-handlers.test.ts

thinking
**Searching for existing auth provider tests**
exec
bash -lc 'rg "auth/providers" -n apps/api' in /var/home/rick/Development/playlist-manager/. succeeded in 47ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
apps/api/src/routes/auth.providers.ts:5:  app.get('/auth/providers', async () => {

thinking
**Searching for related routes**
exec
bash -lc 'rg "spotify" apps/api/src/routes -n' in /var/home/rick/Development/playlist-manager/. succeeded in 42ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
apps/api/src/routes/_mockData.ts:61:    provider: 'spotify',
apps/api/src/routes/jobs/migrate.post.ts:6:  source_provider: 'spotify' | 'deezer' | 'tidal' | 'youtube';
apps/api/src/routes/jobs/migrate.post.ts:8:  dest_provider: 'spotify' | 'deezer' | 'tidal' | 'youtube';
apps/api/src/routes/jobs/migrate.post.ts:14:  const providers = new Set(['spotify', 'deezer', 'tidal', 'youtube']);

thinking
**Checking for provider libraries**
exec
bash -lc 'rg "requireProvider" apps/api -n' in /var/home/rick/Development/playlist-manager/. succeeded in 43ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
apps/api/src/plugins/feature-guard.ts:5:  app.decorate('requireProvider', (name: ProviderFlagName) => {
apps/api/src/plugins/feature-guard.ts:17:    requireProvider(name: ProviderFlagName): void;

thinking
**Checking route setup for integration**
exec
bash -lc 'cat apps/api/src/routes/register-handlers.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 39ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import type { FastifyInstance, RouteShorthandOptions } from 'fastify';

export type RouteDefinition = {
  method: 'GET' | 'POST' | 'PUT' | 'DELETE';
  url: string;
  modulePath: string;
  exportName?: 'default' | 'handler';
  options?: RouteShorthandOptions;
};

const ROUTES: RouteDefinition[] = [
  { method: 'GET',    url: '/playlists',                     modulePath: './playlists/index.get.js' },
  { method: 'GET',    url: '/playlists/:id',                 modulePath: './playlists/[id].get.js' },
  { method: 'GET',    url: '/playlists/:id/items',           modulePath: './playlists/[id]/items.get.js' },
  { method: 'GET',    url: '/active-playlist',               modulePath: './active-playlist/index.get.js' },
  { method: 'PUT',    url: '/active-playlist',               modulePath: './active-playlist/index.put.js' },
  { method: 'POST',   url: '/active-playlist/items',         modulePath: './active-playlist/items/index.post.js' },
  { method: 'DELETE', url: '/active-playlist/items/:itemId', modulePath: './active-playlist/items/[itemId].delete.js' },

thinking
**Searching for authProviders registration**
exec
bash -lc 'rg "auth.providers" -n apps/api' in /var/home/rick/Development/playlist-manager/. succeeded in 44ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
apps/api/src/routes/auth.providers.ts:5:  app.get('/auth/providers', async () => {

thinking
**Checking route registration in server code**
exec
bash -lc 'cat apps/api/src/middleware.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 39ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import type { FastifyInstance } from 'fastify';

import { createResponseValidationHook } from './lib/openapi/validator.js';

export async function registerMiddleware(app: FastifyInstance): Promise<void> {
  const responseValidationHook = await createResponseValidationHook();
  app.addHook('preSerialization', responseValidationHook);
}

thinking
**Searching for server entry point**
exec
bash -lc 'cat apps/api/src/testServer.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 38ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
// apps/api/src/testServer.ts
import fastify, { FastifyInstance } from 'fastify';
import type { Server } from 'http';
import { problem } from './lib/problem.js';
import { registerMiddleware } from './middleware.js';
import { registerRouteHandlers } from './routes/register-handlers.js';

/**
 * Create a Fastify server for tests.
 * If a route module is missing, it is silently skipped (lets you test one route at a time).
 * Wire your OpenAPI response validator inside this function once available.
 */
export async function makeServer(): Promise<Server> {
  const app: FastifyInstance = fastify({
    logger: false, // enable per-test if you need debugging
  });

  // JSON parsing is built-in; add other plugins here if needed.

thinking
**Investigating missing auth providers route**
exec
bash -lc 'rg "registerHandlers" apps/api -n' in /var/home/rick/Development/playlist-manager/. exited 1 in 43ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory

thinking
**Inspecting server setup in apps/api**
exec
bash -lc 'rg "makeServer" -n' in /var/home/rick/Development/playlist-manager/. succeeded in 47ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:319:export async function makeServer(): Promise<Server> {
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:336:bash -lc 'rg "makeServer" -n' in /var/home/rick/Development/playlist-manager/.
codex/LOGS/tasklog_04a_api_validation_wiring_1762394370.log:444:export async function makeServer(): Promise<Server> {
codex/LOGS/tasklog_04a_api_validation_wiring_1762394370.log:54224:    13	export async function makeServer(): Promise<Server> {
codex/TASKS/08c_route_jobs_migrate.yaml:20:    import { makeServer } from '../../testServer';
codex/TASKS/08c_route_jobs_migrate.yaml:24:      const app = await makeServer();
codex/TASKS/07b_route_exports_file.yaml:21:    import { makeServer } from '../../testServer';
codex/TASKS/07b_route_exports_file.yaml:25:      const app = await makeServer();
codex/TASKS/00_repo_sanity_review.yaml:43:      * apps/api/src/dev/start.ts (bootstrap via makeServer)
codex/TASKS/09e_contract_dredd_server.yaml:20:    import { makeServer } from '../testServer';
codex/TASKS/09e_contract_dredd_server.yaml:23:      const srv = await makeServer();
apps/api/src/testServer.ts:13:export async function makeServer(): Promise<Server> {

thinking
**Inspecting server entry point**
exec
bash -lc 'cat apps/api/src/dev/start.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 41ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import Fastify from 'fastify';
import fastifyStatic from '@fastify/static';
import path from 'node:path';
import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
import { registerRouteHandlers } from '../routes/register-handlers.js';
import logging from '../plugins/logging.js';
import metrics from '../plugins/metrics.js';
import featureGuard from '../plugins/feature-guard.js';
import errorsPlugin from '../plugins/errors.js';
import jobEvents from '../routes/jobs.events.js';
import importsFile from '../routes/imports.file.js';

const app = Fastify({ logger: true });

await app.register(fastifyStatic, {
  root: path.join(process.cwd(), 'apps/api/public'),
  prefix: '/',
});

thinking
**Investigating route registration for auth providers**
exec
bash -lc 'rg "providers" apps/api/src/routes -g"*.ts"' in /var/home/rick/Development/playlist-manager/. succeeded in 43ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
apps/api/src/routes/auth.providers.ts:  app.get('/auth/providers', async () => {
apps/api/src/routes/auth.providers.ts:    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
apps/api/src/routes/jobs/migrate.post.ts:  const providers = new Set(['spotify', 'deezer', 'tidal', 'youtube']);
apps/api/src/routes/jobs/migrate.post.ts:    providers.has(body.source_provider) &&
apps/api/src/routes/jobs/migrate.post.ts:    providers.has(body.dest_provider) &&

thinking
**Checking docsRoutes registration**
exec
bash -lc 'cat apps/api/src/routes/docs.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 44ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import { FastifyInstance } from 'fastify';
import path from 'node:path';

export default async function docsRoutes(app: FastifyInstance) {
  // Serve raw spec at /openapi.yaml
  app.get('/openapi.yaml', async (_req, reply) => {
    reply.type('text/yaml');
    return reply.sendFile('openapi.yaml', path.resolve(process.cwd()));
  });

  // Serve UI at /docs
  app.get('/docs', async (_req, reply) => {
    reply.type('text/html');
    return reply.sendFile('docs/index.html');
  });
}

thinking
**Examining feature guard usage in routes**
exec
bash -lc 'cat apps/api/src/routes/jobs/migrate.post.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 41ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import { FastifyReply, FastifyRequest } from 'fastify';
import { enqueueJob } from '../_mockData';
import { problem } from '../../lib/problem';

type Body = {
  source_provider: 'spotify' | 'deezer' | 'tidal' | 'youtube';
  source_playlist_id: number;
  dest_provider: 'spotify' | 'deezer' | 'tidal' | 'youtube';
  dest_playlist_name?: string;
};

function isValidPayload(body: Body | undefined): body is Body {
  if (!body) return false;
  const providers = new Set(['spotify', 'deezer', 'tidal', 'youtube']);
  return (
    providers.has(body.source_provider) &&
    providers.has(body.dest_provider) &&
    typeof body.source_playlist_id === 'number' &&

thinking
**Planning provider guard integration**
exec
bash -lc 'rg "provider" apps/api/src/routes -n' in /var/home/rick/Development/playlist-manager/. succeeded in 44ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
apps/api/src/routes/auth.providers.ts:5:  app.get('/auth/providers', async () => {
apps/api/src/routes/auth.providers.ts:6:    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
apps/api/src/routes/_mockData.ts:6:  provider: string | null;
apps/api/src/routes/_mockData.ts:7:  provider_playlist_id: string | null;
apps/api/src/routes/_mockData.ts:22:  provider_track_id: string | null;
apps/api/src/routes/_mockData.ts:61:    provider: 'spotify',
apps/api/src/routes/_mockData.ts:62:    provider_playlist_id: '37i9dQZF1DX2Nc3B70tvx0',
apps/api/src/routes/_mockData.ts:68:    provider: 'deezer',
apps/api/src/routes/_mockData.ts:69:    provider_playlist_id: '987654321',
apps/api/src/routes/_mockData.ts:86:    provider_track_id: '3urbQpVxWn',
apps/api/src/routes/_mockData.ts:99:    provider_track_id: '9zYpqAbC12',
apps/api/src/routes/_mockData.ts:164:    provider_track_id: randomUUID().slice(0, 10),
apps/api/src/routes/jobs/migrate.post.ts:6:  source_provider: 'spotify' | 'deezer' | 'tidal' | 'youtube';
apps/api/src/routes/jobs/migrate.post.ts:8:  dest_provider: 'spotify' | 'deezer' | 'tidal' | 'youtube';
apps/api/src/routes/jobs/migrate.post.ts:14:  const providers = new Set(['spotify', 'deezer', 'tidal', 'youtube']);
apps/api/src/routes/jobs/migrate.post.ts:16:    providers.has(body.source_provider) &&
apps/api/src/routes/jobs/migrate.post.ts:17:    providers.has(body.dest_provider) &&
apps/api/src/routes/playlists/index.get.ts:5:  provider?: string;

thinking
**Considering provider filter guarding**
exec
bash -lc 'cat apps/api/src/plugins/errors.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 42ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import fp from 'fastify-plugin';
import { nanoid } from 'nanoid';

import { toProblemBody } from '../lib/problem';

export default fp(async (app) => {
  app.addHook('onRequest', async (req) => {
    (req as any).requestId = req.headers['x-request-id'] || nanoid();
  });

  app.setNotFoundHandler((req, reply) => {
    const status = 404;
    const body = toProblemBody({
      status,
      code: 'not_found',
      message: `Route ${req.method}:${req.url} not found`,
      details: null,
      requestId: (req as any).requestId ?? null,

thinking
**Checking problem function consistency**
exec
bash -lc 'cat apps/api/src/lib/problem.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 41ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
export type ProblemOptions = {
  status: number;
  code: string;
  message: string;
  details?: Record<string, unknown> | null;
};

export type ProblemBody = {
  type: string;
  code: string;
  message: string;
  request_id: string | null;
  details: Record<string, unknown> | null;
};

export function problem(options: ProblemOptions): Error {
  const { status, code, message, details } = options;
  const err: any = new Error(message);

thinking
**Ensuring consistent error handling and route protection**

I’m aligning the 503 error with the standard problem format and updating the `featureGuard` plugin to throw errors via the `problem` function for consistent envelopes. I’m also exploring how to hook the `requireProvider` method into routes, considering `request.server` to access the Fastify instance with the plugin decorators for guarding routes, and thinking about leveraging route options for `preHandler` hooks without overhauling all route definitions. Finally, I’ll check the OpenAPI spec to confirm requirements for provider enforcement.
exec
bash -lc 'grep -n "auth/providers" -n openapi.yaml' in /var/home/rick/Development/playlist-manager/. exited 1 in 41ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory

thinking
**Checking for openapi.yaml file**
exec
bash -lc 'ls | head' in /var/home/rick/Development/playlist-manager/. succeeded in 92ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
AGENTS.md
apps
codex
codex.toml
docker-compose.yml
docs
dredd.server.yml
dredd.yml
env.json
node_modules

thinking
**Checking for openapi.yaml file**
exec
bash -lc 'ls openapi.yaml' in /var/home/rick/Development/playlist-manager/. succeeded in 42ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
openapi.yaml

thinking
**Reviewing relevant section**
exec
bash -lc 'rg "auth/providers" openapi.yaml -n' in /var/home/rick/Development/playlist-manager/. exited 1 in 41ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory

thinking
**Verifying spec alignment with routes**
exec
bash -lc "sed -n '1,200p' openapi.yaml" in /var/home/rick/Development/playlist-manager/. succeeded in 44ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
openapi: 3.1.0
info:
  title: playlist-manager API
  version: 1.0.0
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT
servers:
  - url: https://api.playlist-manager.app/api/v1
    description: Production API
  - url: http://{host}:{port}/api/v1
    description: Local development
    variables:
      host:
        default: 127.0.0.1
      port:
        default: '3101'
security:

thinking
**Analyzing spec update requirements**
exec
bash -lc 'grep -n "PROVIDERS" -n .env.example' in /var/home/rick/Development/playlist-manager/. exited 1 in 42ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory

thinking
**Searching for .env.example file**
exec
bash -lc 'ls -a' in /var/home/rick/Development/playlist-manager/. succeeded in 41ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
.
..
AGENTS.md
apps
codex
codex.toml
docker-compose.yml
docs
dredd.server.yml
dredd.yml
.env
.env.example
env.json
.git
.github
.gitignore
node_modules
.npmrc

thinking
**Checking .env.example file**
exec
bash -lc "sed -n '1,160p' .env.example" in /var/home/rick/Development/playlist-manager/. succeeded in 44ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
# Postgres (Prisma reads from DATABASE_URL)
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/tmm_dev?schema=public"

# Shadow DB for Prisma Migrate (recommended)
SHADOW_DATABASE_URL="postgresql://postgres:postgres@localhost:5432/tmm_shadow?schema=public"

# libsodium sealed secret (base64 32 byte seed)
MASTER_KEY="replace-with-base64-secret"

thinking
**Searching for provider flags and tests**
exec
bash -lc 'rg "makeServer" -n apps/api' in /var/home/rick/Development/playlist-manager/. succeeded in 46ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
apps/api/src/testServer.ts:13:export async function makeServer(): Promise<Server> {

thinking
**Checking test patterns with makeServer**
exec
bash -lc 'cat apps/api/src/routes/__tests__/docs.test.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 44ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import { promises as fs } from 'node:fs';
import path from 'node:path';
import { describe, expect, it, vi } from 'vitest';

import docsRoutes from '../docs';

describe('docs routes', () => {
  it('registers /openapi.yaml to stream the repository spec', async () => {
    const get = vi.fn();
    const app = { get } as any;

    await docsRoutes(app);

    const specRoute = get.mock.calls.find(([route]) => route === '/openapi.yaml');
    expect(specRoute).toBeDefined();

    const handler = specRoute?.[1];
    expect(typeof handler).toBe('function');

thinking
**Finding test files**
exec
bash -lc 'cat apps/api/src/routes/__tests__/register-handlers.test.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 41ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import fastify from 'fastify';
import { describe, it, expect } from 'vitest';

import errorsPlugin from '../../plugins/errors';
import { registerRouteHandlers } from '../register-handlers';

describe('registerRouteHandlers', () => {
  async function buildApp() {
    const app = fastify({ logger: false });
    await app.register(errorsPlugin);
    await registerRouteHandlers(app);
    await app.ready();
    return app;
  }

  it('registers playlist routes with successful response', async () => {
    const app = await buildApp();


thinking
**Planning tests and spec updates**
exec
bash -lc 'ls schemas' in /var/home/rick/Development/playlist-manager/. succeeded in 43ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
csv
pif-v1.schema.json

thinking
**Checking OpenAPI components**
exec
bash -lc 'rg "Providers" openapi.yaml -n' in /var/home/rick/Development/playlist-manager/. exited 1 in 40ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory

thinking
**Checking spec's error responses**
exec
bash -lc 'tail -n 200 openapi.yaml' in /var/home/rick/Development/playlist-manager/. succeeded in 41ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
    Error:
      type: object
      required: [type, code, message]
      properties:
        type: { type: string, example: "about:blank" }
        code: { type: string, example: "provider_disabled" }
        message: { type: string, example: "TIDAL is disabled" }
        request_id:
          oneOf:
            - { type: string }
            - { type: 'null' }
        details:
          oneOf:
            - { type: 'null' }
            -
              type: object
              additionalProperties: true


thinking
**Analyzing specification updates for new endpoint**
exec
bash -lc 'rg "ServiceUnavailable" openapi.yaml -n' in /var/home/rick/Development/playlist-manager/. exited 1 in 41ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory

thinking
**Planning feature flag and 503 response handling**

I'm sorting out adding 503 responses for disabled provider routes and figuring out how to test feature flags that are read at module load time. I see I might need to refactor the flags module for dynamic loading or mocking to isolate environment changes in tests. I'll check config patterns next to decide the best approach.
exec
bash -lc 'cat apps/api/src/config/env.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 41ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import { z } from 'zod';

const EnvSchema = z.object({
  MASTER_KEY: z
    .string({
      required_error: 'MASTER_KEY env var is required',
    })
    .min(1),
});

export const env = EnvSchema.parse({
  MASTER_KEY: process.env.MASTER_KEY,
});

thinking
**Analyzing route registration and test strategy**
Plan update
  ✓ Review existing config, routes, and spec to understand current provider listing and guards
  → Add failing tests covering feature flag behavior for disabled providers and blocked routes
  • Implement env-driven feature flags and middleware updates to satisfy tests
  • Run relevant test suite to confirm green

thinking
**Planning tests and environment setup**

This step involves designing failing tests for the `/auth/providers` route and related routes with feature flag toggling. I’m sorting out how to set environment variables before dynamic imports to ensure flags take effect, figuring out where to register the route since it’s currently missing from the handlers list, and considering test strategies including using Fastify with plugins and manual route registration. I also need to reconcile the spec updates with the test-driven workflow, possibly adjusting the plan to insert an explicit spec update step before writing tests.
Plan update
  ✓ Review existing config, routes, and spec to understand current provider listing and guards
  → Update OpenAPI spec and configuration docs to capture provider feature flags
  • Add failing tests covering feature flag behavior for disabled providers and blocked routes
  • Implement env-driven feature flags and middleware updates to satisfy tests
  • Run relevant test suite to confirm green

thinking
**Designing OpenAPI spec updates**

I’m thinking through how to update the OpenAPI spec and env example to reflect the new /auth/providers route and 503 responses, balancing TDD expectations with spec-first updates. I’m carefully considering the response schema for enabled providers only and where to add 503 guards on routes that use feature-flagged providers. Let’s figure out the details before applying the patch.
exec
bash -lc 'cat apps/api/src/routes/exports/file.post.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 93ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import { FastifyReply, FastifyRequest } from 'fastify';
import { enqueueJob } from '../_mockData';
import { problem } from '../../lib/problem';

type Body = {
  playlist_id: number;
  format: 'm3u' | 'xspf' | 'csv';
  variant?: 'lean' | 'verbose';
};

function isValid(body: Body | undefined): body is Body {
  if (!body) return false;
  const formats = new Set(['m3u', 'xspf', 'csv']);
  const variants = new Set(['lean', 'verbose']);
  const variantOk = body.variant ? variants.has(body.variant) : true;
  return (
    typeof body.playlist_id === 'number' &&
    Number.isFinite(body.playlist_id) &&

thinking
**Checking route for provider usage**
exec
bash -lc 'cat apps/api/src/routes/imports.file.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 38ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import { FastifyInstance } from 'fastify';
import { parseCsvToPif } from '@app/interop/src/importers/csv';

export default async function importsFile(app: FastifyInstance) {
  app.post('/imports/file', async (req, reply) => {
    const ct = req.headers['content-type'] || '';
    const body = await req.body;
    if (typeof body !== 'string') {
      const err: any = new Error('Expected text body');
      err.statusCode = 400;
      err.code = 'bad_request';
      throw err;
    }

    if (ct.includes('text/csv')) {
      const pif = parseCsvToPif(body);
      return { preview: pif, counts: { tracks: pif.tracks.length } };
    }

thinking
**Reviewing playlists route**
exec
bash -lc 'cat apps/api/src/routes/playlists/index.get.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 40ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import { FastifyReply, FastifyRequest } from 'fastify';
import { listPlaylists } from '../_mockData';

type Query = {
  provider?: string;
};

export default async function handler(
  request: FastifyRequest<{ Querystring: Query }>,
  reply: FastifyReply,
) {
  const { provider } = request.query ?? {};
  const payload = listPlaylists();

  const filtered = provider
    ? payload.data.filter((playlist) => playlist.provider === provider)
    : payload.data;


thinking
**Designing spec updates for auth providers**

I'm thinking through how to update the spec to add an auth providers list endpoint with appropriate tags, response codes, and schemas. I want to keep the new endpoint restful and consistent with existing patterns, decide on authorization requirements, and plan adding service unavailable responses for specific routes like job migration. I'll also verify current schema and response definitions before implementing changes.
exec
bash -lc 'rg "BadRequest" -n openapi.yaml' in /var/home/rick/Development/playlist-manager/. succeeded in 307ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
52:        '400': { $ref: '#/components/responses/BadRequest' }
177:        '400': { $ref: '#/components/responses/BadRequest' }
212:        '400': { $ref: '#/components/responses/BadRequest' }
265:        '400': { $ref: '#/components/responses/BadRequest' }
324:        '400': { $ref: '#/components/responses/BadRequest' }
347:        "400": { $ref: "#/components/responses/BadRequest" }
368:        "400": { $ref: "#/components/responses/BadRequest" }
451:    BadRequest:

thinking
**Checking components and responses definitions**
exec
bash -lc "sed -n '430,520p' openapi.yaml" in /var/home/rick/Development/playlist-manager/. succeeded in 38ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/ArtistRelation' }
        '401': { $ref: '#/components/responses/Unauthorized' }
        '404': { $ref: '#/components/responses/NotFound' }

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  responses:
    NotFound:
      description: Not found

thinking
**Preparing OpenAPI spec updates**

I’m working on adding a new `ServiceUnavailable` response and an `AuthProvider` schema to the OpenAPI spec. I plan to insert a new `/auth/providers` path tagged with `auth`, update the tags list to include `auth`, and add 503 responses for guarding routes like `POST /jobs/migrate`. I’ll carefully craft a patch to modify tags, paths, and components following the spec’s structure and indentation.
file update
M /var/home/rick/Development/playlist-manager/openapi.yaml
@@ -20,2 +20,4 @@
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
apply_patch(auto_approved=true) exited 0 in 6ms:
Success. Updated the following files:
M openapi.yaml
file update:
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..e1bdf5779b1c791ce8fefcb90fbb27e7779707a5
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist

file update:
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..e1bdf5779b1c791ce8fefcb90fbb27e7779707a5
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist


thinking
**Inserting new API path block**
file update
M /var/home/rick/Development/playlist-manager/openapi.yaml
@@ -33,2 +33,21 @@
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
apply_patch(auto_approved=true) exited 0 in 6ms:
Success. Updated the following files:
M openapi.yaml
file update:
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..8bea406295ea7a57f30f6021a55e87df9c3e065d
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists

file update:
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..8bea406295ea7a57f30f6021a55e87df9c3e065d
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists


thinking
**Verifying OpenAPI formatting and searching paths**
exec
bash -lc 'rg "/jobs/migrate" -n openapi.yaml' in /var/home/rick/Development/playlist-manager/. succeeded in 39ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
254:  /jobs/migrate:
file update:
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..8bea406295ea7a57f30f6021a55e87df9c3e065d
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists


thinking
**Preparing to add 503 response**
exec
bash -lc "sed -n '254,320p' openapi.yaml" in /var/home/rick/Development/playlist-manager/. succeeded in 39ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
  /jobs/migrate:
    post:
      summary: Migrate a playlist between providers
      operationId: jobs_requestMigration
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [source_provider, source_playlist_id, dest_provider]
              properties:
                source_provider: { type: string, enum: [spotify, deezer, tidal, youtube] }
                source_playlist_id: { type: integer }
                dest_provider: { type: string, enum: [spotify, deezer, tidal, youtube] }
                dest_playlist_name: { type: string }
            examples:
              basic:
file update:
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..8bea406295ea7a57f30f6021a55e87df9c3e065d
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists


thinking
**Updating POST /jobs/migrate responses**
file update
M /var/home/rick/Development/playlist-manager/openapi.yaml
@@ -287,2 +287,3 @@
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
apply_patch(auto_approved=true) exited 0 in 7ms:
Success. Updated the following files:
M openapi.yaml
file update:
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..6dc0c2990fee976d572d80d1f311e15d80d9b91d
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:

file update:
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..6dc0c2990fee976d572d80d1f311e15d80d9b91d
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:


thinking
**Adding ServiceUnavailable response definition**
file update
M /var/home/rick/Development/playlist-manager/openapi.yaml
@@ -482,2 +482,7 @@
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
apply_patch(auto_approved=true) exited 0 in 6ms:
Success. Updated the following files:
M openapi.yaml
file update:
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..56856c59c26d35a23e4f658d9340e4a7802b2ba5
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:

file update:
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..56856c59c26d35a23e4f658d9340e4a7802b2ba5
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:


thinking
**Adding AuthProvider schema**
file update
M /var/home/rick/Development/playlist-manager/openapi.yaml
@@ -511,2 +511,9 @@
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
apply_patch(auto_approved=true) exited 0 in 6ms:
Success. Updated the following files:
M openapi.yaml
file update:
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Evaluating AuthProvider response fields**
file update
M /var/home/rick/Development/playlist-manager/.env.example
@@ -8 +8,7 @@
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
apply_patch(auto_approved=true) exited 0 in 6ms:
Success. Updated the following files:
M .env.example
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Updating plan progress**
Plan update
  ✓ Review existing config, routes, and spec to understand current provider listing and guards
  ✓ Update OpenAPI spec and configuration docs to capture provider feature flags
  → Add failing tests covering feature flag behavior for disabled providers and blocked routes
  • Implement env-driven feature flags and middleware updates to satisfy tests
  • Run relevant test suite to confirm green
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Designing failing TDD tests for provider routes**

I'm working out detailed tests to fail at first for filtering disabled providers in `/auth/providers` and for returning 503 on `/jobs/migrate` when providers are disabled. These tests need to carefully reset modules, set env vars before dynamic imports of plugins and routes, and register those on a Fastify instance for injection. I plan to add a new test file with environment setup and teardown that reliably re-imports modules to reflect env changes and verifies expected HTTP responses for these scenarios before implementing the actual logic.
file update
A /var/home/rick/Development/playlist-manager/apps/api/src/routes/__tests__/auth.providers.test.ts
import fastify from 'fastify';
import { afterEach, describe, expect, it, vi } from 'vitest';

function resetProviderEnv() {
  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
  delete process.env.PROVIDERS_DEEZER_ENABLED;
  delete process.env.PROVIDERS_TIDAL_ENABLED;
  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
}

describe('GET /auth/providers', () => {
  afterEach(() => {
    resetProviderEnv();
  });

  it('omits providers that are disabled via flags', async () => {
    vi.resetModules();
    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
    process.env.PROVIDERS_DEEZER_ENABLED = 'true';

    const app = fastify({ logger: false });
    const errorsPlugin = (await import('../../plugins/errors')).default;
    const authProviders = (await import('../auth.providers')).default;

    await app.register(errorsPlugin);
    await authProviders(app);
    await app.ready();

    try {
      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
      expect(response.statusCode).toBe(200);

      const payload = response.json();
      expect(Array.isArray(payload.data)).toBe(true);
      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
      expect(deezer).toBeDefined();
    } finally {
      await app.close();
    }
  });
});

describe('feature guard middleware', () => {
  afterEach(() => {
    resetProviderEnv();
  });

  it('blocks provider-dependent routes when a provider is disabled', async () => {
    vi.resetModules();
    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
    process.env.PROVIDERS_DEEZER_ENABLED = 'true';

    const app = fastify({ logger: false });
    const errorsPlugin = (await import('../../plugins/errors')).default;
    const featureGuard = (await import('../../plugins/feature-guard')).default;
    const migrateHandler = (await import('../jobs/migrate.post')).default;

    await app.register(errorsPlugin);
    await app.register(featureGuard);
    app.post('/jobs/migrate', migrateHandler);
    await app.ready();

    try {
      const response = await app.inject({
        method: 'POST',
        url: '/jobs/migrate',
        payload: {
          source_provider: 'spotify',
          source_playlist_id: 123,
          dest_provider: 'deezer',
          dest_playlist_name: 'Flagged migrate',
        },
      });

      expect(response.statusCode).toBe(503);
      const body = response.json();
      expect(body).toMatchObject({
        type: 'about:blank',
        code: 'provider_disabled',
      });
      expect(body.message).toMatch(/spotify/i);
    } finally {
      await app.close();
    }
  });
}
apply_patch(auto_approved=true) exited 0 in 8ms:
Success. Updated the following files:
A apps/api/src/routes/__tests__/auth.providers.test.ts
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..c8c496ac5b55d546db630d352248827edcad47af
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+}
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..c8c496ac5b55d546db630d352248827edcad47af
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+}
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Checking newline at file end**
exec
bash -lc 'cat apps/api/src/routes/__tests__/auth.providers.test.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 38ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import fastify from 'fastify';
import { afterEach, describe, expect, it, vi } from 'vitest';

function resetProviderEnv() {
  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
  delete process.env.PROVIDERS_DEEZER_ENABLED;
  delete process.env.PROVIDERS_TIDAL_ENABLED;
  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
}

describe('GET /auth/providers', () => {
  afterEach(() => {
    resetProviderEnv();
  });

  it('omits providers that are disabled via flags', async () => {
    vi.resetModules();
    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..c8c496ac5b55d546db630d352248827edcad47af
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+}
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Fixing missing closing parenthesis**
file update
M /var/home/rick/Development/playlist-manager/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -86,2 +86,2 @@
   });
-}
+});
apply_patch(auto_approved=true) exited 0 in 9ms:
Success. Updated the following files:
M apps/api/src/routes/__tests__/auth.providers.test.ts
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Verifying file correctness**
exec
bash -lc 'tail -n 20 apps/api/src/routes/__tests__/auth.providers.test.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 40ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
        payload: {
          source_provider: 'spotify',
          source_playlist_id: 123,
          dest_provider: 'deezer',
          dest_playlist_name: 'Flagged migrate',
        },
      });

      expect(response.statusCode).toBe(503);
      const body = response.json();
      expect(body).toMatchObject({
        type: 'about:blank',
        code: 'provider_disabled',
      });
      expect(body.message).toMatch(/spotify/i);
    } finally {
      await app.close();
    }
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Updating plan status**
Plan update
  ✓ Review existing config, routes, and spec to understand current provider listing and guards
  ✓ Update OpenAPI spec and configuration docs to capture provider feature flags
  ✓ Add failing tests covering feature flag behavior for disabled providers and blocked routes
  → Implement env-driven feature flags and middleware updates to satisfy tests
  • Run relevant test suite to confirm green
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Planning code updates and guards integration**

I'm mapping out modifications to flags management, filtering enabled providers in the auth route, updating feature-guard to throw proper problem errors, and integrating guards into the migrate job route while considering types and test coverage to ensure everything fits smoothly.
exec
bash -lc 'rg "authProviders" -n' in /var/home/rick/Development/playlist-manager/. succeeded in 1.78s:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
openapi.yaml:37:      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:152:export default async function authProviders(app: FastifyInstance) {
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:279:**Searching for authProviders registration**
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:945:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:986:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:1027:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:1076:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:1142:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:1195:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:1244:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:1309:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:1370:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:1449:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:1524:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:1629:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:1718:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:1816:+      operationId: authProviders_list
codex/LOGS/tasklog_04d_config_feature_flags_1762396882.log:1899:    const authProviders = (await import('../auth.providers')).default;
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Planning route registration and feature flags**

I'll check that the server registers the new route properly by updating both the development start script and the test server setup to include the auth providers and feature guard plugins. I want to ensure consistency between actual and test servers and consider adding support for loading feature flags from environment variables or possibly a JSON config like the existing env.json file. I'll verify how these pieces fit together to properly implement Step 4.
exec
bash -lc 'cat env.json' in /var/home/rick/Development/playlist-manager/. succeeded in 59ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
{
"PROVIDERS_SPOTIFY":"true",
"PROVIDERS_DEEZER":"true",
"PROVIDERS_TIDAL":"true",
"PROVIDERS_YOUTUBE":"true",
"PROVIDERS_AMAZON":"false",
}
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object



thinking
**Analyzing feature-flag integration and plugin enhancements**
thinking
**Finalizing plugin decorations and route registrations**

I’m ensuring the plugin methods decorate both the Fastify instance and request with type-safe functions to require providers, including adding helpers for multiple providers. I’m planning updates to the migrate route to call these guards after payload validation, plus registering the authProviders route in the dev server and optionally in tests for consistency. I’ll proceed to patch the config and routes accordingly to finalize integration.
file update
M /var/home/rick/Development/playlist-manager/apps/api/src/config/flags.ts
@@ -5,3 +5,3 @@
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
@@ -17 +17,7 @@
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
apply_patch(auto_approved=true) exited 0 in 9ms:
Success. Updated the following files:
M apps/api/src/config/flags.ts
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Updating import usage and applying new function**
file update
M /var/home/rick/Development/playlist-manager/apps/api/src/routes/auth.providers.ts
@@ -1,3 +1,3 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
@@ -5,3 +5,3 @@
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
apply_patch(auto_approved=true) exited 0 in 10ms:
Success. Updated the following files:
M apps/api/src/routes/auth.providers.ts
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Updating feature-guard module**
file update
M /var/home/rick/Development/playlist-manager/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +0,0 @@
-import fp from 'fastify-plugin';
-import { isProviderEnabled, ProviderFlagName } from '../config/flags';
-
-export default fp(async (app) => {
-  app.decorate('requireProvider', (name: ProviderFlagName) => {
-    if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
-    }
-  });
-});
-
-declare module 'fastify' {
-  interface FastifyInstance {
-    requireProvider(name: ProviderFlagName): void;
-  }
-}
apply_patch(auto_approved=true) exited 0 in 11ms:
Success. Updated the following files:
M apps/api/src/plugins/feature-guard.ts
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +0,0 @@
-import fp from 'fastify-plugin';
-import { isProviderEnabled, ProviderFlagName } from '../config/flags';
-
-export default fp(async (app) => {
-  app.decorate('requireProvider', (name: ProviderFlagName) => {
-    if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
-    }
-  });
-});
-
-declare module 'fastify' {
-  interface FastifyInstance {
-    requireProvider(name: ProviderFlagName): void;
-  }
-}
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +0,0 @@
-import fp from 'fastify-plugin';
-import { isProviderEnabled, ProviderFlagName } from '../config/flags';
-
-export default fp(async (app) => {
-  app.decorate('requireProvider', (name: ProviderFlagName) => {
-    if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
-    }
-  });
-});
-
-declare module 'fastify' {
-  interface FastifyInstance {
-    requireProvider(name: ProviderFlagName): void;
-  }
-}
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Preparing to update file content**
file update
M /var/home/rick/Development/playlist-manager/apps/api/src/plugins/feature-guard.ts
@@ -0,0 +1,34 @@
+import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
+import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
+
+export default fp(async (app) => {
+  app.decorate('requireProvider', (name: ProviderFlagName) => {
+    if (!isProviderEnabled(name)) {
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
+    }
+  });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
+});
+
+declare module 'fastify' {
+  interface FastifyInstance {
+    requireProvider(name: ProviderFlagName): void;
+  }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
+}
apply_patch(auto_approved=true) exited 0 in 11ms:
Success. Updated the following files:
M apps/api/src/plugins/feature-guard.ts
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Preparing to update migration job**
file update
M /var/home/rick/Development/playlist-manager/apps/api/src/routes/jobs/migrate.post.ts
@@ -30,2 +30,6 @@
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
apply_patch(auto_approved=true) exited 0 in 12ms:
Success. Updated the following files:
M apps/api/src/routes/jobs/migrate.post.ts
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Clarifying TypeScript typings and route registration**

I'm sorting out how TypeScript treats the `body` variable within the request and making sure the type guards and assignments align without confusing the compiler. I’m also preparing to update `dev/start.ts` by importing and registering the new `authProviders` route plugin in the right spot alongside existing ones to keep things organized.
file update
M /var/home/rick/Development/playlist-manager/apps/api/src/dev/start.ts
@@ -4,2 +4,3 @@
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
@@ -25,2 +26,3 @@
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
apply_patch(auto_approved=true) exited 0 in 19ms:
Success. Updated the following files:
M apps/api/src/dev/start.ts
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Planning plugin registration updates**

I’m figuring out how to update `testServer.ts` and `makeServer` to register plugins like `featureGuard`, `authProviders`, and especially `errorsPlugin` to keep test server behavior consistent with the main app. I’ll carefully handle import paths with `.js` extensions and ensure the registration order keeps error handling and middleware hooks intact.
file update
M /var/home/rick/Development/playlist-manager/apps/api/src/testServer.ts
@@ -4,3 +4,6 @@
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
@@ -27,4 +30,7 @@
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
apply_patch(auto_approved=true) exited 0 in 22ms:
Success. Updated the following files:
M apps/api/src/testServer.ts
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Verifying import path extensions**
exec
bash -lc "sed -n '1,160p' apps/api/src/testServer.ts" in /var/home/rick/Development/playlist-manager/. succeeded in 58ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
// apps/api/src/testServer.ts
import fastify, { FastifyInstance } from 'fastify';
import type { Server } from 'http';
import { problem } from './lib/problem.js';
import errorsPlugin from './plugins/errors.js';
import featureGuard from './plugins/feature-guard.js';
import { registerMiddleware } from './middleware.js';
import authProviders from './routes/auth.providers.js';
import { registerRouteHandlers } from './routes/register-handlers.js';

/**
 * Create a Fastify server for tests.
 * If a route module is missing, it is silently skipped (lets you test one route at a time).
 * Wire your OpenAPI response validator inside this function once available.
 */
export async function makeServer(): Promise<Server> {
  const app: FastifyInstance = fastify({
    logger: false, // enable per-test if you need debugging
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Verifying provider-related integrations**
Plan update
  ✓ Review existing config, routes, and spec to understand current provider listing and guards
  ✓ Update OpenAPI spec and configuration docs to capture provider feature flags
  ✓ Add failing tests covering feature flag behavior for disabled providers and blocked routes
  ✓ Implement env-driven feature flags and middleware updates to satisfy tests
  → Run relevant test suite to confirm green
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Preparing to run tests**
exec
bash -lc 'cat package.json' in /var/home/rick/Development/playlist-manager/. succeeded in 63ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
{
  "name": "playlist-manager",
  "private": true,
  "version": "0.1.0",
  "type": "module",
  "packageManager": "pnpm@9.12.3",
  "engines": {
    "node": ">=18.18"
  },
  "workspaces": [
    "apps/*",
    "packages/*"
  ],
  "scripts": {
    "lint:api": "redocly lint openapi.yaml --extends recommended",
    "gen:types": "openapi-typescript openapi.yaml -o packages/contracts/src/api.types.ts",
    "mock:api": "prism mock openapi.yaml",
    "check:breaking": "oasdiff breaking origin:openapi.yaml openapi.yaml --warn-added",
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Preparing to run targeted tests**
exec
bash -lc 'pnpm vitest --run apps/api/src/routes/__tests__/auth.providers.test.ts' in /var/home/rick/Development/playlist-manager/. exited 1 in 3.13s:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory

 RUN  v3.1.1 /var/home/rick/Development/playlist-manager


⎯⎯⎯⎯⎯⎯ Failed Suites 1 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  apps/api/src/routes/__tests__/auth.providers.test.ts [ apps/api/src/routes/__tests__/auth.providers.test.ts ]
Error: Failed to load url fastify (resolved id: fastify) in /var/home/rick/Development/playlist-manager/apps/api/src/routes/__tests__/auth.providers.test.ts. Does the file exist?
 ❯ loadAndTransform node_modules/vite/dist/node/chunks/dep-Bid9ssRr.js:41317:17

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/1]⎯


 Test Files  1 failed (1)
      Tests  no tests
   Start at  21:49:15
   Duration  551ms (transform 94ms, setup 0ms, collect 0ms, tests 0ms, environment 1ms, prepare 96ms)

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Investigating Vitest fastify import issue**
exec
bash -lc 'cat vitest.config.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 107ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    include: [
      'packages/**/test/**/*.test.ts',
      'packages/**/tests/**/*.test.ts',
      'apps/**/src/**/__tests__/**/*.test.ts',
      'codex/code/**/tests/**/*.test.ts',
    ],
    testTimeout: 30000,
    pool: 'threads',
  },
});
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Verifying test file pattern matching**
exec
bash -lc 'pnpm vitest --run apps/api/src/routes/__tests__/register-handlers.test.ts' in /var/home/rick/Development/playlist-manager/. exited 1 in 2.67s:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory

 RUN  v3.1.1 /var/home/rick/Development/playlist-manager


⎯⎯⎯⎯⎯⎯ Failed Suites 1 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  apps/api/src/routes/__tests__/register-handlers.test.ts [ apps/api/src/routes/__tests__/register-handlers.test.ts ]
Error: Failed to load url fastify (resolved id: fastify) in /var/home/rick/Development/playlist-manager/apps/api/src/routes/__tests__/register-handlers.test.ts. Does the file exist?
 ❯ loadAndTransform node_modules/vite/dist/node/chunks/dep-Bid9ssRr.js:41317:17

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/1]⎯


 Test Files  1 failed (1)
      Tests  no tests
   Start at  21:49:28
   Duration  482ms (transform 63ms, setup 0ms, collect 0ms, tests 0ms, environment 1ms, prepare 132ms)

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Investigating module resolution issue**
exec
bash -lc 'ls node_modules/fastify' in /var/home/rick/Development/playlist-manager/. succeeded in 39ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
index.d.ts
index.js
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Analyzing Vite and Fastify load issues**
exec
bash -lc 'cat node_modules/fastify/package.json' in /var/home/rick/Development/playlist-manager/. exited 1 in 40ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
cat: node_modules/fastify/package.json: No such file or directory
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Investigating fastify package structure**
exec
bash -lc 'ls -la node_modules/fastify' in /var/home/rick/Development/playlist-manager/. succeeded in 39ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
total 8
drwxr-xr-x  1 rick rick    36 Nov  5 21:26 .
drwxr-xr-x. 1 rick rick 15760 Nov  5 21:28 ..
-rw-r--r--  1 rick rick   178 Nov  5 21:26 index.d.ts
-rw-r--r--  1 rick rick   158 Nov  5 21:26 index.js
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Inspecting symlink behavior**
exec
bash -lc 'cat node_modules/fastify/index.js' in /var/home/rick/Development/playlist-manager/. succeeded in 42ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
function fastify() {
  throw new Error('fastify runtime is not available in this environment');
}
module.exports = fastify;
module.exports.default = fastify;
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Investigating fastify stub issue**
exec
bash -lc 'ls node_modules/.pnpm | grep fastify' in /var/home/rick/Development/playlist-manager/. exited 1 in 40ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
ls: cannot access 'node_modules/.pnpm': No such file or directory
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Checking for pnpm directory**
exec
bash -lc 'ls node_modules | head' in /var/home/rick/Development/playlist-manager/. succeeded in 90ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
acorn
acorn-jsx
ajv
@ampproject
ansi-align
ansi-escapes
ansi-regex
ansis
ansi-styles
@antfu
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9cafb079045a48b1e9adeb4c0a973dc2c6ddde69
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,87 @@
+import fastify from 'fastify';
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const authProviders = (await import('../auth.providers')).default;
+
+    await app.register(errorsPlugin);
+    await authProviders(app);
+    await app.ready();
+
+    try {
+      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
+      expect(response.statusCode).toBe(200);
+
+      const payload = response.json();
+      expect(Array.isArray(payload.data)).toBe(true);
+      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+      expect(deezer).toBeDefined();
+    } finally {
+      await app.close();
+    }
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const app = fastify({ logger: false });
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    await app.register(errorsPlugin);
+    await app.register(featureGuard);
+    app.post('/jobs/migrate', migrateHandler);
+    await app.ready();
+
+    try {
+      const response = await app.inject({
+        method: 'POST',
+        url: '/jobs/migrate',
+        payload: {
+          source_provider: 'spotify',
+          source_playlist_id: 123,
+          dest_provider: 'deezer',
+          dest_playlist_name: 'Flagged migrate',
+        },
+      });
+
+      expect(response.statusCode).toBe(503);
+      const body = response.json();
+      expect(body).toMatchObject({
+        type: 'about:blank',
+        code: 'provider_disabled',
+      });
+      expect(body.message).toMatch(/spotify/i);
+    } finally {
+      await app.close();
+    }
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object



thinking
**Devising fastify-independent test strategy**

I'm figuring out how to test the route and plugin logic without importing the real fastify, since it’s stubbed out to prevent actual server use. I plan to mock minimal app objects with decorate methods, manually call route handlers, and simulate requests and error handling to verify behavior—all without relying on fastify itself. This approach should let me run meaningful tests despite the stub blocking real fastify imports.
thinking
**Redesigning tests with dynamic imports and app stubs**

I'm updating tests to use dynamic imports after setting environment variables to ensure fresh configurations load per test. To avoid importing fastify, I’ll stub app and request objects with needed methods, capturing decorators and hooks so plugins like featureGuard and errorsPlugin can run properly. This will let me invoke route handlers and error handlers manually, verifying behavior without requiring a real fastify server or static module imports.
file update
M /var/home/rick/Development/playlist-manager/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -1,87 +0,0 @@
-import fastify from 'fastify';
-import { afterEach, describe, expect, it, vi } from 'vitest';
-
-function resetProviderEnv() {
-  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
-  delete process.env.PROVIDERS_DEEZER_ENABLED;
-  delete process.env.PROVIDERS_TIDAL_ENABLED;
-  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
-}
-
-describe('GET /auth/providers', () => {
-  afterEach(() => {
-    resetProviderEnv();
-  });
-
-  it('omits providers that are disabled via flags', async () => {
-    vi.resetModules();
-    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
-    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
-
-    const app = fastify({ logger: false });
-    const errorsPlugin = (await import('../../plugins/errors')).default;
-    const authProviders = (await import('../auth.providers')).default;
-
-    await app.register(errorsPlugin);
-    await authProviders(app);
-    await app.ready();
-
-    try {
-      const response = await app.inject({ method: 'GET', url: '/auth/providers' });
-      expect(response.statusCode).toBe(200);
-
-      const payload = response.json();
-      expect(Array.isArray(payload.data)).toBe(true);
-      expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
-      const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
-      expect(deezer).toBeDefined();
-    } finally {
-      await app.close();
-    }
-  });
-});
-
-describe('feature guard middleware', () => {
-  afterEach(() => {
-    resetProviderEnv();
-  });
-
-  it('blocks provider-dependent routes when a provider is disabled', async () => {
-    vi.resetModules();
-    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
-    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
-
-    const app = fastify({ logger: false });
-    const errorsPlugin = (await import('../../plugins/errors')).default;
-    const featureGuard = (await import('../../plugins/feature-guard')).default;
-    const migrateHandler = (await import('../jobs/migrate.post')).default;
-
-    await app.register(errorsPlugin);
-    await app.register(featureGuard);
-    app.post('/jobs/migrate', migrateHandler);
-    await app.ready();
-
-    try {
-      const response = await app.inject({
-        method: 'POST',
-        url: '/jobs/migrate',
-        payload: {
-          source_provider: 'spotify',
-          source_playlist_id: 123,
-          dest_provider: 'deezer',
-          dest_playlist_name: 'Flagged migrate',
-        },
-      });
-
-      expect(response.statusCode).toBe(503);
-      const body = response.json();
-      expect(body).toMatchObject({
-        type: 'about:blank',
-        code: 'provider_disabled',
-      });
-      expect(body.message).toMatch(/spotify/i);
-    } finally {
-      await app.close();
-    }
-  });
-});
apply_patch(auto_approved=true) exited 0 in 20ms:
Success. Updated the following files:
M apps/api/src/routes/__tests__/auth.providers.test.ts
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..e69de29bb2d1d6434b8b29ae775ad8c2e48c5391
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Adding new content with a stub**
file update
M /var/home/rick/Development/playlist-manager/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,139 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
apply_patch(auto_approved=true) exited 0 in 20ms:
Success. Updated the following files:
M apps/api/src/routes/__tests__/auth.providers.test.ts
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..2ee248296f0e0b1fdf2fc27f0d92670afdcfb80f
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,139 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..2ee248296f0e0b1fdf2fc27f0d92670afdcfb80f
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,139 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Verifying plugin integrations and test setup**

I’m double-checking that all plugin integrations like error handling and feature guards are properly wired up on the stub app, including verifying that decorators and mock calls behave as expected. I’m also ensuring environment resets and module resets happen correctly between tests before running them again to validate these setups.
exec
bash -lc 'pnpm vitest --run apps/api/src/routes/__tests__/auth.providers.test.ts' in /var/home/rick/Development/playlist-manager/. exited 1 in 2.40s:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory

 RUN  v3.1.1 /var/home/rick/Development/playlist-manager

 ❯ apps/api/src/routes/__tests__/auth.providers.test.ts (2 tests | 1 failed) 103ms
   ✓ GET /auth/providers > omits providers that are disabled via flags 21ms
   × feature guard middleware > blocks provider-dependent routes when a provider is disabled 81ms
     → Failed to load url fastify-plugin (resolved id: fastify-plugin) in /var/home/rick/Development/playlist-manager/apps/api/src/plugins/errors.ts. Does the file exist?

⎯⎯⎯⎯⎯⎯⎯ Failed Tests 1 ⎯⎯⎯⎯⎯⎯⎯

 FAIL  apps/api/src/routes/__tests__/auth.providers.test.ts > feature guard middleware > blocks provider-dependent routes when a provider is disabled
Error: Failed to load url fastify-plugin (resolved id: fastify-plugin) in /var/home/rick/Development/playlist-manager/apps/api/src/plugins/errors.ts. Does the file exist?
 ❯ loadAndTransform node_modules/vite/dist/node/chunks/dep-Bid9ssRr.js:41317:17

⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯[1/1]⎯


 Test Files  1 failed (1)
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..2ee248296f0e0b1fdf2fc27f0d92670afdcfb80f
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,139 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Checking fastify-plugin module availability**
exec
bash -lc 'ls node_modules/fastify-plugin' in /var/home/rick/Development/playlist-manager/. succeeded in 112ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
index.d.ts
index.js
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..2ee248296f0e0b1fdf2fc27f0d92670afdcfb80f
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,139 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Mocking fastify-plugin for tests**

I’m figuring out how to stub `fastify-plugin` to avoid bundler failures by mocking it to just return the plugin function directly. Since the tests dynamically import modules after resetting modules, I’ll ensure to call `vi.doMock` with an identity function and `__esModule: true` before each import to keep the mock effective. It seems safest to place a top-level `vi.mock` after importing `vi` from 'vitest' so the mock persists across tests without interfering. This approach should smooth out plugin-related issues during testing.
file update
M /var/home/rick/Development/playlist-manager/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -2,2 +2,7 @@
 
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
 type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
apply_patch(auto_approved=true) exited 0 in 16ms:
Success. Updated the following files:
M apps/api/src/routes/__tests__/auth.providers.test.ts
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Rerunning tests to check mocks**
exec
bash -lc 'pnpm vitest --run apps/api/src/routes/__tests__/auth.providers.test.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 2.58s:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory

 RUN  v3.1.1 /var/home/rick/Development/playlist-manager

 ✓ apps/api/src/routes/__tests__/auth.providers.test.ts (2 tests) 178ms

 Test Files  1 passed (1)
      Tests  2 passed (2)
   Start at  21:51:43
   Duration  640ms (transform 218ms, setup 0ms, collect 68ms, tests 178ms, environment 1ms, prepare 98ms)

file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Completing plan step**
Plan update
  ✓ Review existing config, routes, and spec to understand current provider listing and guards
  ✓ Update OpenAPI spec and configuration docs to capture provider feature flags
  ✓ Add failing tests covering feature flag behavior for disabled providers and blocked routes
  ✓ Implement env-driven feature flags and middleware updates to satisfy tests
  ✓ Run relevant test suite to confirm green
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Preparing final response**
exec
bash -lc 'git status -sb' in /var/home/rick/Development/playlist-manager/. succeeded in 115ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
## main...origin/main [ahead 11]
 M .env.example
 M apps/api/src/config/flags.ts
 M apps/api/src/dev/start.ts
 M apps/api/src/plugins/feature-guard.ts
 M apps/api/src/routes/auth.providers.ts
 M apps/api/src/routes/jobs/migrate.post.ts
 M apps/api/src/testServer.ts
 M openapi.yaml
?? apps/api/src/config/env.ts
?? apps/api/src/lib/crypto/
?? apps/api/src/lib/openapi/
?? apps/api/src/middleware.ts
?? apps/api/src/routes/__tests__/auth.providers.test.ts
?? apps/api/src/routes/__tests__/docs.test.ts
?? codex.toml
?? codex/LOGS/codex_run_2025-11-05_20-47-49.log
?? codex/LOGS/tasklog_03c_token_encryption_at_rest_1762393669.log
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Reviewing untracked files and preparing summary**
exec
bash -lc 'nl -ba apps/api/src/routes/auth.providers.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 95ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
     1	import { FastifyInstance } from 'fastify';
     2	import { getEnabledProviders } from '../config/flags';
     3	
     4	export default async function authProviders(app: FastifyInstance) {
     5	  app.get('/auth/providers', async () => {
     6	    const data = getEnabledProviders().map((name) => ({ name }));
     7	    return { data };
     8	  });
     9	}
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Checking FastifyInstance usage and next file**
exec
bash -lc 'nl -ba apps/api/src/config/flags.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 55ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
     1	export type ProviderFlagName = 'spotify' | 'deezer' | 'tidal' | 'youtube';
     2	
     3	const bool = (v: string | undefined, d = false) =>
     4	  v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
     5	
     6	export const flags: { providers: Record<ProviderFlagName, boolean> } = {
     7	  providers: {
     8	    spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     9	    deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
    10	    tidal:   bool(process.env.PROVIDERS_TIDAL_ENABLED, false),
    11	    youtube: bool(process.env.PROVIDERS_YOUTUBE_ENABLED, false)
    12	  }
    13	};
    14	
    15	export function isProviderEnabled(name: ProviderFlagName): boolean {
    16	  return !!flags.providers[name];
    17	}
    18	
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Preparing to review feature-guard plugin**
exec
bash -lc 'nl -ba apps/api/src/plugins/feature-guard.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 45ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
     1	import fp from 'fastify-plugin';
     2	import type { FastifyRequest } from 'fastify';
     3	
     4	import { isProviderEnabled, ProviderFlagName } from '../config/flags';
     5	import { problem } from '../lib/problem';
     6	
     7	export default fp(async (app) => {
     8	  app.decorate('requireProvider', (name: ProviderFlagName) => {
     9	    if (!isProviderEnabled(name)) {
    10	      throw problem({
    11	        status: 503,
    12	        code: 'provider_disabled',
    13	        message: `${name} provider is disabled`,
    14	      });
    15	    }
    16	  });
    17	
    18	  app.decorateRequest(
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Checking migration route file**
exec
bash -lc 'nl -ba apps/api/src/routes/jobs/migrate.post.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 51ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
     1	import { FastifyReply, FastifyRequest } from 'fastify';
     2	import { enqueueJob } from '../_mockData';
     3	import { problem } from '../../lib/problem';
     4	
     5	type Body = {
     6	  source_provider: 'spotify' | 'deezer' | 'tidal' | 'youtube';
     7	  source_playlist_id: number;
     8	  dest_provider: 'spotify' | 'deezer' | 'tidal' | 'youtube';
     9	  dest_playlist_name?: string;
    10	};
    11	
    12	function isValidPayload(body: Body | undefined): body is Body {
    13	  if (!body) return false;
    14	  const providers = new Set(['spotify', 'deezer', 'tidal', 'youtube']);
    15	  return (
    16	    providers.has(body.source_provider) &&
    17	    providers.has(body.dest_provider) &&
    18	    typeof body.source_playlist_id === 'number' &&
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Noting request.requireProvider addition**
exec
bash -lc 'nl -ba apps/api/src/dev/start.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 42ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
     1	import Fastify from 'fastify';
     2	import fastifyStatic from '@fastify/static';
     3	import path from 'node:path';
     4	import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
     5	import authProviders from '../routes/auth.providers.js';
     6	import { registerRouteHandlers } from '../routes/register-handlers.js';
     7	import logging from '../plugins/logging.js';
     8	import metrics from '../plugins/metrics.js';
     9	import featureGuard from '../plugins/feature-guard.js';
    10	import errorsPlugin from '../plugins/errors.js';
    11	import jobEvents from '../routes/jobs.events.js';
    12	import importsFile from '../routes/imports.file.js';
    13	
    14	const app = Fastify({ logger: true });
    15	
    16	await app.register(fastifyStatic, {
    17	  root: path.join(process.cwd(), 'apps/api/public'),
    18	  prefix: '/',
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Noting authProviders registration and testServer lines**
exec
bash -lc 'nl -ba apps/api/src/testServer.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 43ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
     1	// apps/api/src/testServer.ts
     2	import fastify, { FastifyInstance } from 'fastify';
     3	import type { Server } from 'http';
     4	import { problem } from './lib/problem.js';
     5	import errorsPlugin from './plugins/errors.js';
     6	import featureGuard from './plugins/feature-guard.js';
     7	import { registerMiddleware } from './middleware.js';
     8	import authProviders from './routes/auth.providers.js';
     9	import { registerRouteHandlers } from './routes/register-handlers.js';
    10	
    11	/**
    12	 * Create a Fastify server for tests.
    13	 * If a route module is missing, it is silently skipped (lets you test one route at a time).
    14	 * Wire your OpenAPI response validator inside this function once available.
    15	 */
    16	export async function makeServer(): Promise<Server> {
    17	  const app: FastifyInstance = fastify({
    18	    logger: false, // enable per-test if you need debugging
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Documenting openapi.yaml additions**
exec
bash -lc 'rg -n "/auth/providers" openapi.yaml' in /var/home/rick/Development/playlist-manager/. succeeded in 56ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
34:  /auth/providers:
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Checking specific lines in file**
exec
bash -lc "nl -ba openapi.yaml | sed -n '30,80p'" in /var/home/rick/Development/playlist-manager/. succeeded in 41ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
    30	    description: Export playlist snapshots into provider formats
    31	  - name: artists
    32	    description: Artist catalogue and follow operations
    33	paths:
    34	  /auth/providers:
    35	    get:
    36	      summary: List enabled auth providers
    37	      operationId: authProviders_list
    38	      tags: [auth]
    39	      responses:
    40	        '200':
    41	          description: OK
    42	          content:
    43	            application/json:
    44	              schema:
    45	                type: object
    46	                required: [data]
    47	                properties:
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Planning 503 error handling**
exec
bash -lc "nl -ba openapi.yaml | sed -n '270,320p'" in /var/home/rick/Development/playlist-manager/. succeeded in 39ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
   270	            examples:
   271	              basic:
   272	                value:
   273	                  source_provider: spotify
   274	                  source_playlist_id: 1
   275	                  dest_provider: tidal
   276	                  dest_playlist_name: "Migrated — My Mix"
   277	      responses:
   278	        '202':
   279	          description: Accepted
   280	          content:
   281	            application/json:
   282	              schema: { $ref: '#/components/schemas/JobRef' }
   283	              examples:
   284	                accepted:
   285	                  value: { job_id: 456, status: "queued" }
   286	        '400': { $ref: '#/components/responses/BadRequest' }
   287	        '401': { $ref: '#/components/responses/Unauthorized' }
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Noting new AuthProvider component**
exec
bash -lc "nl -ba openapi.yaml | sed -n '430,520p'" in /var/home/rick/Development/playlist-manager/. succeeded in 40ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
   430	            type: string
   431	            pattern: '^[0-9a-fA-F-]{36}$'
   432	            example: '123e4567-e89b-12d3-a456-426614174000'
   433	            default: '123e4567-e89b-12d3-a456-426614174000'
   434	          examples:
   435	            default:
   436	              value: '123e4567-e89b-12d3-a456-426614174000'
   437	          x-example: '123e4567-e89b-12d3-a456-426614174000'
   438	        - in: query
   439	          name: types
   440	          schema:
   441	            type: array
   442	            items: { type: string, enum: [influences, influenced_by, collaborated_with, member_of, has_members] }
   443	            uniqueItems: true
   444	          style: form
   445	          explode: false
   446	      responses:
   447	        '200':
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Noting lines and additions**
exec
bash -lc 'nl -ba .env.example' in /var/home/rick/Development/playlist-manager/. succeeded in 38ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
     1	# Postgres (Prisma reads from DATABASE_URL)
     2	DATABASE_URL="postgresql://postgres:postgres@localhost:5432/tmm_dev?schema=public"
     3	
     4	# Shadow DB for Prisma Migrate (recommended)
     5	SHADOW_DATABASE_URL="postgresql://postgres:postgres@localhost:5432/tmm_shadow?schema=public"
     6	
     7	# libsodium sealed secret (base64 32 byte seed)
     8	MASTER_KEY="replace-with-base64-secret"
     9	
    10	# Provider feature flags
    11	PROVIDERS_SPOTIFY_ENABLED="true"
    12	PROVIDERS_DEEZER_ENABLED="false"
    13	PROVIDERS_TIDAL_ENABLED="false"
    14	PROVIDERS_YOUTUBE_ENABLED="false"
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Noting new test file lines**
exec
bash -lc 'nl -ba apps/api/src/routes/__tests__/auth.providers.test.ts' in /var/home/rick/Development/playlist-manager/. succeeded in 38ms:
/home/rick/.bashrc: line 30: /home/rick/.config/broot/launcher/bash/br: No such file or directory
/home/rick/.bash_profile: line 10: /home/rick/.config/broot/launcher/bash/br: No such file or directory
     1	import { afterEach, describe, expect, it, vi } from 'vitest';
     2	
     3	vi.mock('fastify-plugin', () => ({
     4	  default: (fn: any) => fn,
     5	  __esModule: true,
     6	}));
     7	
     8	type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
     9	
    10	function resetProviderEnv() {
    11	  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
    12	  delete process.env.PROVIDERS_DEEZER_ENABLED;
    13	  delete process.env.PROVIDERS_TIDAL_ENABLED;
    14	  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
    15	}
    16	
    17	function createStubApp() {
    18	  const requestDecorators: RequestDecoratorMap = {};
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object


thinking
**Summarizing final message details**

I'm gathering all the key modifications, including mocking `fastify-plugin` for self-contained tests, updates to `openapi.yaml`, route registration, feature flag usage, and `.env.example` documentation. I'll organize these into clear **Changes** and **Tests** sections with line references, test commands, and a brief overview to create a well-structured final message that aligns with instructions.
codex
Feature flagging now drives which providers surface and hard-blocks migrations against anything toggled off while keeping the API spec in sync.

**Changes**
- `openapi.yaml:34` adds the `/auth/providers` contract, `ServiceUnavailable` response, and an `AuthProvider` schema so the spec reflects the new flag-driven behaviour.
- `.env.example:10` documents the `PROVIDERS_*_ENABLED` switches for quick configuration.
- `apps/api/src/config/flags.ts:6` types the provider flag map and exposes `getEnabledProviders()` for reuse.
- `apps/api/src/routes/auth.providers.ts:4` now returns only enabled providers.
- `apps/api/src/plugins/feature-guard.ts:7` upgrades the guard to throw a `problem` envelope and decorates requests for easy `requireProvider` checks.
- `apps/api/src/routes/jobs/migrate.post.ts:31` enforces the guard on both source and destination providers before queueing a migration.
- `apps/api/src/dev/start.ts:5` and `apps/api/src/testServer.ts:31` register the guard and `/auth/providers` route during bootstrap.
- `apps/api/src/routes/__tests__/auth.providers.test.ts:1` adds coverage (with a stubbed Fastify env) for filtered listings and the 503 error envelope when a provider is disabled.

**Tests**
- `pnpm vitest --run apps/api/src/routes/__tests__/auth.providers.test.ts`

Natural next step is to flip each provider flag in a local env and hit the real server to double-check the new guard behaviour end-to-end.
file update:
diff --git a/.env.example b/.env.example
index 2666bc73a0ddbaf553d0b710b4cac94df53278aa..0565e44fca5fe274a5f5304d069390de0214beee
--- a/.env.example
+++ b/.env.example
@@ -6,3 +6,9 @@
 
 # libsodium sealed secret (base64 32 byte seed)
 MASTER_KEY="replace-with-base64-secret"
+
+# Provider feature flags
+PROVIDERS_SPOTIFY_ENABLED="true"
+PROVIDERS_DEEZER_ENABLED="false"
+PROVIDERS_TIDAL_ENABLED="false"
+PROVIDERS_YOUTUBE_ENABLED="false"
diff --git a/apps/api/src/config/flags.ts b/apps/api/src/config/flags.ts
index 298cbc153787c6213fa648753a74c6f3d58da702..83d38de1b4fe28b56df24bbc3a9ee8b3e4fd159d
--- a/apps/api/src/config/flags.ts
+++ b/apps/api/src/config/flags.ts
@@ -3,7 +3,7 @@
 const bool = (v: string | undefined, d = false) =>
   v ? ['1','true','yes','on'].includes(v.toLowerCase()) : d;
 
-export const flags = {
+export const flags: { providers: Record<ProviderFlagName, boolean> } = {
   providers: {
     spotify: bool(process.env.PROVIDERS_SPOTIFY_ENABLED, true),
     deezer:  bool(process.env.PROVIDERS_DEEZER_ENABLED, false),
@@ -15,3 +15,9 @@
 export function isProviderEnabled(name: ProviderFlagName): boolean {
   return !!flags.providers[name];
 }
+
+export function getEnabledProviders(): ProviderFlagName[] {
+  return (Object.entries(flags.providers) as Array<[ProviderFlagName, boolean]>)
+    .filter(([, enabled]) => enabled)
+    .map(([name]) => name);
+}
diff --git a/apps/api/src/dev/start.ts b/apps/api/src/dev/start.ts
index 3fb2e6b0162da0dd1de9c9b13b3b0c3eb4672949..79ac53f4683317601b1718c5901c61932fe7096b
--- a/apps/api/src/dev/start.ts
+++ b/apps/api/src/dev/start.ts
@@ -2,6 +2,7 @@
 import fastifyStatic from '@fastify/static';
 import path from 'node:path';
 import docsRoutes from '../routes/docs.js'; // ensure .ts resolves via tsx; .js is ok too
+import authProviders from '../routes/auth.providers.js';
 import { registerRouteHandlers } from '../routes/register-handlers.js';
 import logging from '../plugins/logging.js';
 import metrics from '../plugins/metrics.js';
@@ -23,6 +24,7 @@
 await app.register(featureGuard);
 
 await app.register(docsRoutes);
+await app.register(authProviders);
 await app.register(jobEvents);
 await app.register(importsFile);
 
diff --git a/apps/api/src/plugins/feature-guard.ts b/apps/api/src/plugins/feature-guard.ts
index b96bd2dbc85339821684e7e65f5768636608a978..8dd41dd91a97af94c8b84f1db3b5c7790085d80c
--- a/apps/api/src/plugins/feature-guard.ts
+++ b/apps/api/src/plugins/feature-guard.ts
@@ -1,19 +1,34 @@
 import fp from 'fastify-plugin';
+import type { FastifyRequest } from 'fastify';
+
 import { isProviderEnabled, ProviderFlagName } from '../config/flags';
+import { problem } from '../lib/problem';
 
 export default fp(async (app) => {
   app.decorate('requireProvider', (name: ProviderFlagName) => {
     if (!isProviderEnabled(name)) {
-      const err: any = new Error(`${name} is disabled`);
-      err.statusCode = 503;
-      err.code = 'provider_disabled';
-      throw err;
+      throw problem({
+        status: 503,
+        code: 'provider_disabled',
+        message: `${name} provider is disabled`,
+      });
     }
   });
+
+  app.decorateRequest(
+    'requireProvider',
+    function (this: FastifyRequest, name: ProviderFlagName) {
+      app.requireProvider(name);
+    },
+  );
 });
 
 declare module 'fastify' {
   interface FastifyInstance {
     requireProvider(name: ProviderFlagName): void;
   }
+
+  interface FastifyRequest {
+    requireProvider(name: ProviderFlagName): void;
+  }
 }
diff --git a/apps/api/src/routes/__tests__/auth.providers.test.ts b/apps/api/src/routes/__tests__/auth.providers.test.ts
new file mode 100644
index 0000000000000000000000000000000000000000..9580493f27574890520d9ac0c0781a73500e8910
--- /dev/null
+++ b/apps/api/src/routes/__tests__/auth.providers.test.ts
@@ -0,0 +1,144 @@
+import { afterEach, describe, expect, it, vi } from 'vitest';
+
+vi.mock('fastify-plugin', () => ({
+  default: (fn: any) => fn,
+  __esModule: true,
+}));
+
+type RequestDecoratorMap = Record<string, (...args: any[]) => unknown>;
+
+function resetProviderEnv() {
+  delete process.env.PROVIDERS_SPOTIFY_ENABLED;
+  delete process.env.PROVIDERS_DEEZER_ENABLED;
+  delete process.env.PROVIDERS_TIDAL_ENABLED;
+  delete process.env.PROVIDERS_YOUTUBE_ENABLED;
+}
+
+function createStubApp() {
+  const requestDecorators: RequestDecoratorMap = {};
+
+  const app: any = {
+    requestDecorators,
+    decorators: {} as Record<string, any>,
+    decorate(name: string, value: unknown) {
+      this.decorators[name] = value;
+      this[name] = value;
+      return this;
+    },
+    decorateRequest(name: string, value: (...args: any[]) => unknown) {
+      requestDecorators[name] = value;
+      return this;
+    },
+    addHook: vi.fn(),
+    setNotFoundHandler(handler: unknown) {
+      this.notFoundHandler = handler;
+      return this;
+    },
+    setErrorHandler(handler: any) {
+      this.errorHandler = handler;
+      return this;
+    },
+    log: {
+      warn: vi.fn(),
+    },
+  };
+
+  return app;
+}
+
+function createRequest(app: any, requestDecorators: RequestDecoratorMap, body: Record<string, unknown>) {
+  const request: any = {
+    body,
+    headers: {},
+    server: app,
+  };
+
+  for (const [name, fn] of Object.entries(requestDecorators)) {
+    request[name] = function (...args: any[]) {
+      return fn.apply(request, args);
+    };
+  }
+
+  return request;
+}
+
+describe('GET /auth/providers', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('omits providers that are disabled via flags', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const authProviders = (await import('../auth.providers')).default;
+
+    const get = vi.fn();
+    await authProviders({ get } as any);
+
+    const [, handler] = get.mock.calls.at(0)!;
+    const payload = await handler();
+
+    expect(Array.isArray(payload.data)).toBe(true);
+    expect(payload.data.find((provider: any) => provider.name === 'spotify')).toBeUndefined();
+    const deezer = payload.data.find((provider: any) => provider.name === 'deezer');
+    expect(deezer).toBeDefined();
+  });
+});
+
+describe('feature guard middleware', () => {
+  afterEach(() => {
+    resetProviderEnv();
+  });
+
+  it('blocks provider-dependent routes when a provider is disabled', async () => {
+    vi.resetModules();
+    process.env.PROVIDERS_SPOTIFY_ENABLED = 'false';
+    process.env.PROVIDERS_DEEZER_ENABLED = 'true';
+
+    const errorsPlugin = (await import('../../plugins/errors')).default;
+    const featureGuard = (await import('../../plugins/feature-guard')).default;
+    const migrateHandler = (await import('../jobs/migrate.post')).default;
+
+    const app = createStubApp();
+    await errorsPlugin(app);
+    await featureGuard(app);
+
+    const request = createRequest(app, app.requestDecorators, {
+      source_provider: 'spotify',
+      source_playlist_id: 123,
+      dest_provider: 'deezer',
+      dest_playlist_name: 'Flagged migrate',
+    });
+
+    const reply = {
+      status: vi.fn().mockReturnThis(),
+      send: vi.fn(),
+    };
+
+    let caught: any;
+    try {
+      await migrateHandler(request, reply as any);
+    } catch (error) {
+      caught = error;
+    }
+
+    expect(caught).toBeDefined();
+    expect(caught).toMatchObject({
+      statusCode: 503,
+      code: 'provider_disabled',
+    });
+
+    await app.errorHandler(caught, request, reply as any);
+
+    expect(reply.status).toHaveBeenCalledWith(503);
+    expect(reply.send).toHaveBeenCalledTimes(1);
+    const [body] = reply.send.mock.calls[0];
+    expect(body).toMatchObject({
+      type: 'about:blank',
+      code: 'provider_disabled',
+    });
+    expect(body.message).toMatch(/spotify/i);
+  });
+});
diff --git a/apps/api/src/routes/auth.providers.ts b/apps/api/src/routes/auth.providers.ts
index 3c4f3ac04d6aab292e76850bcb3403b2eac94f86..70eeee5cdcf97df485ad10c984ba36cbf09198f9
--- a/apps/api/src/routes/auth.providers.ts
+++ b/apps/api/src/routes/auth.providers.ts
@@ -1,9 +1,9 @@
 import { FastifyInstance } from 'fastify';
-import { flags } from '../config/flags';
+import { getEnabledProviders } from '../config/flags';
 
 export default async function authProviders(app: FastifyInstance) {
   app.get('/auth/providers', async () => {
-    const data = Object.entries(flags.providers).map(([name, enabled]) => ({ name, enabled }));
+    const data = getEnabledProviders().map((name) => ({ name }));
     return { data };
   });
 }
diff --git a/apps/api/src/routes/jobs/migrate.post.ts b/apps/api/src/routes/jobs/migrate.post.ts
index 6a0a91b8605af37263a003b326a3d5228ed426d5..80c48d2e927db8fb01cb9771ad2d40afedb5381f
--- a/apps/api/src/routes/jobs/migrate.post.ts
+++ b/apps/api/src/routes/jobs/migrate.post.ts
@@ -28,6 +28,10 @@
     throw problem({ status: 400, code: 'invalid_migration_request', message: 'Invalid migration request' });
   }
 
+  const body = request.body;
+  request.requireProvider(body.source_provider);
+  request.requireProvider(body.dest_provider);
+
   const { jobRef } = enqueueJob('migrate');
   return reply.status(202).send(jobRef);
 }
diff --git a/apps/api/src/testServer.ts b/apps/api/src/testServer.ts
index d411b08858588d1dce3d234b5cb2b0e1304fd185..ad5edb98b7716dbb49832adcc3aa2b931733b795
--- a/apps/api/src/testServer.ts
+++ b/apps/api/src/testServer.ts
@@ -2,7 +2,10 @@
 import fastify, { FastifyInstance } from 'fastify';
 import type { Server } from 'http';
 import { problem } from './lib/problem.js';
+import errorsPlugin from './plugins/errors.js';
+import featureGuard from './plugins/feature-guard.js';
 import { registerMiddleware } from './middleware.js';
+import authProviders from './routes/auth.providers.js';
 import { registerRouteHandlers } from './routes/register-handlers.js';
 
 /**
@@ -25,8 +28,11 @@
     }
   });
 
+  await app.register(errorsPlugin);
+  await app.register(featureGuard);
   await registerMiddleware(app);
 
+  await app.register(authProviders);
   await registerRouteHandlers(app);
 
   await app.ready();
diff --git a/openapi.yaml b/openapi.yaml
index 65effb0872af82e39fcf02836bccfedab4037f33..bf1f9dd9e4b0bc74f87a28a34ad280607d0a19a3
--- a/openapi.yaml
+++ b/openapi.yaml
@@ -18,6 +18,8 @@
 security:
   - {}
 tags:
+  - name: auth
+    description: Authentication provider metadata
   - name: playlists
     description: Playlist management endpoints
   - name: active-playlist
@@ -29,6 +31,25 @@
   - name: artists
     description: Artist catalogue and follow operations
 paths:
+  /auth/providers:
+    get:
+      summary: List enabled auth providers
+      operationId: authProviders_list
+      tags: [auth]
+      responses:
+        '200':
+          description: OK
+          content:
+            application/json:
+              schema:
+                type: object
+                required: [data]
+                properties:
+                  data:
+                    type: array
+                    items: { $ref: '#/components/schemas/AuthProvider' }
+        '401': { $ref: '#/components/responses/Unauthorized' }
+
   /playlists:
     get:
       summary: List user playlists
@@ -264,6 +285,7 @@
                   value: { job_id: 456, status: "queued" }
         '400': { $ref: '#/components/responses/BadRequest' }
         '401': { $ref: '#/components/responses/Unauthorized' }
+        '503': { $ref: '#/components/responses/ServiceUnavailable' }
 
   /jobs/{id}:
     get:
@@ -458,6 +480,11 @@
       content:
         application/json:
           schema: { $ref: '#/components/schemas/Error' }
+    ServiceUnavailable:
+      description: Service unavailable
+      content:
+        application/json:
+          schema: { $ref: '#/components/schemas/Error' }
     UnprocessableEntity:
       description: Unprocessable entity
       content:
@@ -482,6 +509,13 @@
             -
               type: object
               additionalProperties: true
+    AuthProvider:
+      type: object
+      required: [name]
+      properties:
+        name:
+          type: string
+          enum: [spotify, deezer, tidal, youtube]
 
     PagedPlaylists:
       type: object

tokens used
247,314
Feature flagging now drives which providers surface and hard-blocks migrations against anything toggled off while keeping the API spec in sync.

**Changes**
- `openapi.yaml:34` adds the `/auth/providers` contract, `ServiceUnavailable` response, and an `AuthProvider` schema so the spec reflects the new flag-driven behaviour.
- `.env.example:10` documents the `PROVIDERS_*_ENABLED` switches for quick configuration.
- `apps/api/src/config/flags.ts:6` types the provider flag map and exposes `getEnabledProviders()` for reuse.
- `apps/api/src/routes/auth.providers.ts:4` now returns only enabled providers.
- `apps/api/src/plugins/feature-guard.ts:7` upgrades the guard to throw a `problem` envelope and decorates requests for easy `requireProvider` checks.
- `apps/api/src/routes/jobs/migrate.post.ts:31` enforces the guard on both source and destination providers before queueing a migration.
- `apps/api/src/dev/start.ts:5` and `apps/api/src/testServer.ts:31` register the guard and `/auth/providers` route during bootstrap.
- `apps/api/src/routes/__tests__/auth.providers.test.ts:1` adds coverage (with a stubbed Fastify env) for filtered listings and the 503 error envelope when a provider is disabled.

**Tests**
- `pnpm vitest --run apps/api/src/routes/__tests__/auth.providers.test.ts`

Natural next step is to flip each provider flag in a local env and hit the real server to double-check the new guard behaviour end-to-end.
